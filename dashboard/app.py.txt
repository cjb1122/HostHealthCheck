from flask import Flask, render_template, jsonify
import json
import os

app = Flask(__name__)

DATA_DIR = os.path.join(os.path.dirname(__file__), "..", "aggregator", "storage")


def load_json(filename):
    path = os.path.join(DATA_DIR, filename)
    if not os.path.exists(path):
        return {}
    with open(path, "r") as f:
        return json.load(f)


@app.route("/")
def home():
    """Show list of all servers."""
    servers = load_json("servers.json")
    return render_template("index.html", servers=servers)


@app.route("/server/<server_id>")
def server_details(server_id):
    """Detailed metrics for a single server."""
    servers = load_json("servers.json")
    server = servers.get(server_id, None)

    if not server:
        return f"Server '{server_id}' not found.", 404

    return render_template("server.html", server=server, server_id=server_id)


@app.route("/api/servers")
def api_servers():
    """Return all server metrics as JSON."""
    return jsonify(load_json("servers.json"))


@app.route("/api/server/<server_id>")
def api_server(server_id):
    """Return one server's metrics as JSON."""
    servers = load_json("servers.json")
    return jsonify(servers.get(server_id, {}))


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
